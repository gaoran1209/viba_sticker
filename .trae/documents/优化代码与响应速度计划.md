# 优化 Viba Sticker Bot 响应速度与代码质量计划 (更新版)

根据您的要求，我们将重点优化响应速度，并将所有与用户的交互提示统一为 **英文**。

## 1. 核心优化：AI 服务层 (ai_service.py)
### 引入超时机制
- 为 `aiohttp` 请求添加明确的 `timeout` 参数（主模型建议 30s）。
- 使用 `asyncio.wait_for` 包装主模型调用。如果 `gemini-3-pro-image-preview` 在 30s 内未响应，立即主动中断并切换到 `gemini-2.5-flash-image`。

### 优化连接管理
- 优化 `AIService` 类，使其复用同一个 `aiohttp.ClientSession`。这将减少每次请求建立 TCP 连接的开销。

### 优化 Fallback 逻辑
- 缩短等待阈值。如果第一次尝试在短时间内失败，立即重试；如果响应时间过长，直接跳过重试进入 Fallback 流程。

## 2. 交互体验优化 (bot.py)
### 统一交互语言为英文
- 确保所有报错信息、状态提示、成功通知均使用 **英文**。
- 例如：将 "❌ 请上传图片文件！" 改为 "❌ Please upload an image file!"。

### 进度反馈
- 在用户等待超过 15s 时，利用 Discord 的交互机制提供反馈，例如 "✨ Processing your sticker, please wait a moment..."。

## 3. 环境与依赖优化
### 消除启动警告
- 在 `requirements.txt` 中添加 `pynacl` 以消除 Discord 语音支持警告。
- 添加 `Pillow` (PIL) 库。在发送图片给 Gemini 之前，先检查并压缩超大图片，这能显著减少网络传输时间并提高 API 成功率。

## 4. 关键改进点
- **日志记录**：记录每个子任务（图片下载、API 调用、图片处理）的精确耗时。
- **错误提示**：针对 API 限制（Rate Limit）或安全过滤（Safety Filter）提供清晰的英文反馈。

---
请确认以上计划，确认后我将开始执行代码修改。